---
title: "EDS222_final_proj"
output: html_document
---

---
title: "final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r }
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(sf)
library(mapview)
library(tmap)
library(leaflet)
library(rosm)
library(prettymapr)
library(kableExtra)
library(xtable)
library(sjPlot)
library(webshot)
library(gt)
library(ggmap)
```


```{r, band data}
# read in banding data
albie_band <- read_csv(here("data", "laal_bfal_ca_hi_bbl2021.csv")) #both bfal and laal banding data for CA and HI
```

```{r}
# explore banding data
# unique(albie_all_band$event_year)
# head(albie_all_band)
#unique(albie_all_band$species_name)
#unique(albie_all_band$event_date)
#class(albie_all_band$event_date)
```


```{r}
albie_band <- albie_band %>% 
  mutate(species = case_when(
    species_scientific_name == "Phoebastria immutabilis" ~ "LAAL",
    species_scientific_name == "Phoebastria nigripes" ~ "BFAL")) %>% 
  relocate(species, .after = original_band) %>% 
  relocate(species_name, .after = species) %>% 
  relocate(species_scientific_name, .after = species_name) %>% 
  mutate(count = as.numeric("1")) %>% 
  relocate(count, .after = species_scientific_name) %>% 
  mutate(event_date = as.Date(event_date, "%m/%d/%y")) %>% 
  rename(year = event_year) #%>% 
  #select(c(-other_bands, -who_obtained_code))
 
```

```{r}
# convert database to sf element to create geom
albie_sf <- st_as_sf(albie_band, 
                       coords = c("lon_dd","lat_dd"), 
                       crs = 4326)

```

```{r}
# mapview(albie_sf,
#         map.types = c("Stamen.Terrain"),
#         layer.name = "Laysan and Black-footed albatross",
#         col.regions = "#F757E1")

tm_shape(albie_sf) +
  tm_dots("elev") +
  tm_layout(title = "Figure 4. Distribution of break-ins by elevation")
```

```{r}

band_count <- albie_band %>% 
  group_by(species, year) %>% 
  summarise(total = sum(count))

```

```{r warning=FALSE}
#plot banding data

band_plot <- ggplot(band_count, aes(x = year, y = total, group = species)) +
  geom_point(aes(color = species,
                 shape = species)) +
  geom_line(aes(color = species)) +
  scale_color_manual(name = "Albatross species",
                     values = c("#9E7E8C", "#39ACB1"),
                     labels = c("Black-footed Albatross", "Laysan Albatross")) +
  geom_vline(xintercept = 2011,
             linetype = "solid",
             color = "goldenrod1",
             size = 2) +
  guides(shape = FALSE) +
  annotate("text",
           label = "Tōhoku tsunami",
           x = 2014,
           y = 4700,
           color = "black",
           size = 4) +
  labs(title = "Hawaii & California Albatross Banding Effort",
       x = "Year",
       y = "Albatross Banded",
       color = "Species") +
  theme_minimal() +
  theme(legend.background = element_blank(),
        legend.position = "bottom")  
  
band_plot
```

```{r}
ggsave("images/band_plot.png",
       width = 6,
       height = 4,
       units = "in",
       bg = "white",
       dpi = "print")
```

```{r}
# create two band count dataframes based on species
bfal_band <- split(band_count, band_count$species)[[1]]
laal_band <- split(band_count, band_count$species)[[2]]
```

```{r}
# create new column for year pre-tsunami (0) and post(1), 2011 = post as tsuanmi occurred before banding season began
bfal_band <- bfal_band %>% 
  mutate(t_event = case_when(
    year <= "2010" ~ "0",
    year >= "2011" ~ "1")
    )
  
laal_band <- laal_band %>%
  mutate(t_event = case_when(
    year <= "2010" ~ "0",
    year >= "2011" ~ "1")
    )
  
```

```{r}
# explore population data 1996 - 2021

bfal_mean <- round(mean(bfal_band$total), 2)
bfal_min <- round(min(bfal_band$total), 2)
bfal_max <- round(max(bfal_band$total), 2)

laal_mean <- round(mean(laal_band$total), 2)
laal_min <- round(min(laal_band$total), 2)
laal_max <- round(max(laal_band$total), 2)

```

```{r}
# table with mean, min, max for both albatross species

```


```{r}
bfal_qqplot <- ggplot(bfal_band) +
  geom_qq(aes(sample = total),
          color = "#9E7E8C",
          size = 3) +
  geom_qq_line(aes(sample = total),
            color = "grey") +
  xlab("Normal distribution quantiles") +
  ylab("Sample quantiles") +
  labs(title = "Black-footed Albatross QQ Plot") +
  theme_minimal() +
  theme(line = element_blank(),
        panel.grid = element_blank(),
        strip.text = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
bfal_qqplot  
  
```

```{r}
ggsave("images/bfal_qqplot.png",
       width = 4,
       height = 4,
       units = "in",
       bg = "white",
       dpi = "print")
```

```{r}
laal_qqplot <- ggplot(laal_band) +
  geom_qq(aes(sample = total),
          color = "#39ACB1",
          size = 3) +
  geom_qq_line(aes(sample = total),
            color = "grey") +
  xlab("Normal distribution quantiles") +
  ylab("Sample quantiles") +
  labs(title = "Laysan Albatross QQ Plot") +
  theme_minimal() +
  theme(line = element_blank(),
        panel.grid = element_blank(),
        strip.text = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        legend.position = "none")
laal_qqplot  
```

```{r}
ggsave("images/laal_qqplot.png",
       width = 4,
       height = 4,
       units = "in",
       bg = "white",
       dpi = "print")
```

```{r}
# filter species by pre and post tsunami event
bfal_pre <- bfal_band %>% 
  filter(year %in% c(2002:2010))

bfal_post <- bfal_band %>% 
  filter(year %in% c(2011:2020))

laal_pre <- laal_band %>% 
  filter(year %in% c(2002:2010))

laal_post <- laal_band %>% 
  filter(year %in% c(2011:2020))

```

```{r}
# mean population of species pre and post tsunami event

mean_pre_bfal <- round(mean(bfal_pre$total), 2)
mean_post_bfal <- round(mean(bfal_post$total), 2)

mean_pre_laal <- round(mean(laal_pre$total), 2)
mean_post_laal <- round(mean(laal_post$total), 2)

```

```{r}

pop_mean <- tibble(species = c("BFAL", "LAAL"),
                       mean_pre = c(mean_pre_bfal, mean_pre_laal),
                       mean_post = c(mean_post_bfal, mean_post_laal))

pop_mean_table <- knitr::kable(pop_mean,
                               col.names = c('Species', 'Pre_Pop_Mean', 'Post_Pop_Mean'),
                               caption = "Albatross Population Means Pre & Post Tōhoku Tsunami") %>% 
  kable_classic(full_width = F, html_font = "Cambria") #%>% 
  #save_kable(file = "albie_mean_pops.png",
             #zoom = 1.5)

pop_mean_table


```

```{r}
# save mean population data 
#write.csv(pop_mean, file = file.choose(new = T))

```

$$ \text{Albatross population trend}_i = \beta_0 + \beta_1 \text{time since tsunami}_i + \varepsilon_i $$

$$ \text{Albatross count}_i = \beta_0 + \beta_1 \text{count_year-1} + \beta_2 \text{tsunami event}_i + \varepsilon_i $$

```{r}

bfal_lm <- summary(lm(total ~ year, data = bfal_post)) %>% 
  #xtable() %>% 
  #kable(caption = "Simple Linear Regression - Albatross population post-tsunami") #%>% 
  #save_kable(file = "bfal_lm.png")
  tab_model(title = "Simple Linear Regression - Black-footed Albatross population post-tsunami",
    file = "bfal_lm_tab.html") 
  
bfal_lm 
```

```{r}

laal_lm <- summary(lm(total ~ year, data = laal_post)) %>% 
  #xtable() %>% 
  #kable(caption = "Simple Linear Regression - Albatross population post-tsunami") #%>% 
  #save_kable(file = "bfal_lm.png")
  tab_model(title = "Simple Linear Regression - Laysan Albatross population post-tsunami",
    file = "laal_lm_tab.html") 
  
laal_lm 
```

```{r}
# save simple linear regressions to png

webshot("bfal_lm_tab.html", "bfal_lm_tab.png")
```

